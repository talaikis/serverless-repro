"use strict";var e=require("./tslib.es6-adbab166.js"),t=require("./v4-aa48ebe9.js"),r=function(t){return function(r,n){return function(o){return e.__awaiter(void 0,void 0,void 0,(function(){var a;return e.__generator(this,(function(i){return(null===(a=null==t?void 0:t.retryStrategy)||void 0===a?void 0:a.mode)&&(n.userAgent=e.__spreadArray(e.__spreadArray([],e.__read(n.userAgent||[])),[["cfg/retry-mode",t.retryStrategy.mode]])),[2,t.retryStrategy.retry(r,o)]}))}))}}},n={name:"retryMiddleware",tags:["RETRY"],step:"finalizeRequest",priority:"high",override:!0},o=function(){function t(e){this.method=e.method||"GET",this.hostname=e.hostname||"localhost",this.port=e.port,this.query=e.query||{},this.headers=e.headers||{},this.body=e.body,this.protocol=e.protocol?":"!==e.protocol.substr(-1)?e.protocol+":":e.protocol:"https:",this.path=e.path?"/"!==e.path.charAt(0)?"/"+e.path:e.path:"/"}return t.isInstance=function(e){if(!e)return!1;var t=e;return"method"in t&&"protocol"in t&&"hostname"in t&&"path"in t&&"object"==typeof t.query&&"object"==typeof t.headers},t.prototype.clone=function(){var r,n=new t(e.__assign(e.__assign({},this),{headers:e.__assign({},this.headers)}));return n.query&&(n.query=(r=n.query,Object.keys(r).reduce((function(t,n){var o,a=r[n];return e.__assign(e.__assign({},t),((o={})[n]=Array.isArray(a)?e.__spreadArray([],e.__read(a)):a,o))}),{}))),n},t}();var a=["AuthFailure","InvalidSignatureException","RequestExpired","RequestInTheFuture","RequestTimeTooSkewed","SignatureDoesNotMatch"],i=["BandwidthLimitExceeded","EC2ThrottledException","LimitExceededException","PriorRequestNotComplete","ProvisionedThroughputExceededException","RequestLimitExceeded","RequestThrottled","RequestThrottledException","SlowDown","ThrottledException","Throttling","ThrottlingException","TooManyRequestsException","TransactionInProgressException"],s=["AbortError","TimeoutError","RequestTimeout","RequestTimeoutException"],u=[500,502,503,504],d=function(e){var t,r;return 429===(null===(t=e.$metadata)||void 0===t?void 0:t.httpStatusCode)||i.includes(e.name)||1==(null===(r=e.$retryable)||void 0===r?void 0:r.throttling)},c=function(e,t){return Math.floor(Math.min(2e4,Math.random()*Math.pow(2,t)*e))},l=function(e){return!!e&&(function(e){return void 0!==e.$retryable}(e)||function(e){return a.includes(e.name)}(e)||d(e)||function(e){var t;return s.includes(e.name)||u.includes((null===(t=e.$metadata)||void 0===t?void 0:t.httpStatusCode)||0)}(e))},p=function(){function r(e,t){var r,n,o,a,i,s,u,d;this.maxAttemptsProvider=e,this.mode="standard",this.retryDecider=null!==(r=null==t?void 0:t.retryDecider)&&void 0!==r?r:l,this.delayDecider=null!==(n=null==t?void 0:t.delayDecider)&&void 0!==n?n:c,this.retryQuota=null!==(o=null==t?void 0:t.retryQuota)&&void 0!==o?o:(i=a=500,s=a,u=function(e){return"TimeoutError"===e.name?10:5},d=function(e){return u(e)<=s},Object.freeze({hasRetryTokens:d,retrieveRetryTokens:function(e){if(!d(e))throw new Error("No retry token available");var t=u(e);return s-=t,t},releaseRetryTokens:function(e){s+=null!=e?e:1,s=Math.min(s,i)}}))}return r.prototype.shouldRetry=function(e,t,r){return t<r&&this.retryDecider(e)&&this.retryQuota.hasRetryTokens(e)},r.prototype.getMaxAttempts=function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.maxAttemptsProvider()];case 1:return t=e.sent(),[3,3];case 2:return e.sent(),t=3,[3,3];case 3:return[2,t]}}))}))},r.prototype.retry=function(r,n){return e.__awaiter(this,void 0,void 0,(function(){var a,i,s,u,c,l,p,h;return e.__generator(this,(function(y){switch(y.label){case 0:return i=0,s=0,[4,this.getMaxAttempts()];case 1:u=y.sent(),c=n.request,o.isInstance(c)&&(c.headers["amz-sdk-invocation-id"]=t.v4()),l=function(){var t,l,h,y,_;return e.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,5]),o.isInstance(c)&&(c.headers["amz-sdk-request"]="attempt="+(i+1)+"; max="+u),[4,r(n)];case 1:return t=e.sent(),l=t.response,h=t.output,p.retryQuota.releaseRetryTokens(a),h.$metadata.attempts=i+1,h.$metadata.totalRetryDelay=s,[2,{value:{response:l,output:h}}];case 2:return y=e.sent(),i++,p.shouldRetry(y,i,u)?(a=p.retryQuota.retrieveRetryTokens(y),_=p.delayDecider(d(y)?500:100,i),s+=_,[4,new Promise((function(e){return setTimeout(e,_)}))]):[3,4];case 3:return e.sent(),[2,"continue"];case 4:throw y.$metadata||(y.$metadata={}),y.$metadata.attempts=i,y.$metadata.totalRetryDelay=s,y;case 5:return[2]}}))},p=this,y.label=2;case 2:return[5,l()];case 3:return"object"==typeof(h=y.sent())?[2,h.value]:[3,2];case 4:return[2]}}))}))},r}(),h={environmentVariableSelector:function(e){var t=e.AWS_MAX_ATTEMPTS;if(t){var r=parseInt(t);if(Number.isNaN(r))throw new Error('Environment variable AWS_MAX_ATTEMPTS mast be a number, got "'+t+'"');return r}},configFileSelector:function(e){var t=e.max_attempts;if(t){var r=parseInt(t);if(Number.isNaN(r))throw new Error('Shared config file entry max_attempts mast be a number, got "'+t+'"');return r}},default:3},y=function(e){if(void 0===e&&(e=3),"number"==typeof e){var t=Promise.resolve(e);return function(){return t}}return e},_={environmentVariableSelector:function(e){return e.AWS_RETRY_MODE},configFileSelector:function(e){return e.retry_mode},default:"standard"};exports.CONFIG_MAX_ATTEMPTS="max_attempts",exports.CONFIG_RETRY_MODE="retry_mode",exports.DEFAULT_MAX_ATTEMPTS=3,exports.DEFAULT_RETRY_MODE="standard",exports.ENV_MAX_ATTEMPTS="AWS_MAX_ATTEMPTS",exports.ENV_RETRY_MODE="AWS_RETRY_MODE",exports.HttpRequest=o,exports.INVOCATION_ID_HEADER="amz-sdk-invocation-id",exports.NODE_MAX_ATTEMPT_CONFIG_OPTIONS=h,exports.NODE_RETRY_MODE_CONFIG_OPTIONS=_,exports.REQUEST_HEADER="amz-sdk-request",exports.StandardRetryStrategy=p,exports.defaultDelayDecider=c,exports.defaultRetryDecider=l,exports.getRetryPlugin=function(e){return{applyToStack:function(t){t.add(r(e),n)}}},exports.resolveRetryConfig=function(t){var r=y(t.maxAttempts);return e.__assign(e.__assign({},t),{maxAttempts:r,retryStrategy:t.retryStrategy||new p(r)})},exports.retryMiddleware=r,exports.retryMiddlewareOptions=n;
