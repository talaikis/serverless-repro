"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("stream"),t=require("zlib"),r=require("http"),a=require("./manifest.json");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=o(e),i=o(t),s=o(r),d=o(a);const u={"accept-encoding":!0,"content-length":!0,"if-modified-since":!0,"if-none-match":!0,"if-range":!0,"if-unmodified-since":!0,"transfer-encoding":!0,via:!0},c={202:"Accepted",502:"Bad Gateway",400:"Bad Request",409:"Conflict",100:"Continue",201:"Created",417:"Expectation Failed",424:"Failed Dependency",403:"Forbidden",504:"Gateway Timeout",410:"Gone",505:"HTTP Version Not Supported",418:"I'm a teapot",419:"Insufficient Space on Resource",507:"Insufficient Storage",500:"Server Error",411:"Length Required",423:"Locked",420:"Method Failure",405:"Method Not Allowed",301:"Moved Permanently",302:"Moved Temporarily",207:"Multi-Status",300:"Multiple Choices",511:"Network Authentication Required",204:"No Content",203:"Non Authoritative Information",406:"Not Acceptable",404:"Not Found",501:"Not Implemented",304:"Not Modified",200:"OK",206:"Partial Content",402:"Payment Required",308:"Permanent Redirect",412:"Precondition Failed",428:"Precondition Required",102:"Processing",407:"Proxy Authentication Required",431:"Request Header Fields Too Large",408:"Request Timeout",413:"Request Entity Too Large",414:"Request-URI Too Long",416:"Requested Range Not Satisfiable",205:"Reset Content",303:"See Other",503:"Service Unavailable",101:"Switching Protocols",307:"Temporary Redirect",429:"Too Many Requests",401:"Unauthorized",422:"Unprocessable Entity",415:"Unsupported Media Type",305:"Use Proxy"},l={enableHTTPCompression:!1},h=(e,{enableHTTPCompression:t,rewrittenUri:r}=l)=>{const{request:a,response:o={headers:{}}}=e,d={headers:{}},h=new n.default.Readable,p=Object.assign(h,s.default.IncomingMessage.prototype);p.url=r||a.uri,p.method=a.method,p.rawHeaders=[],p.headers={},p.connection={},a.querystring&&(p.url=p.url+"?"+a.querystring);const f=a.headers||{};for(const e of Object.keys(f)){const t=f[e];t.forEach((e=>{p.rawHeaders.push(e.key),p.rawHeaders.push(e.value)})),p.headers[e]=t[0].value}p.getHeader=e=>p.headers[e.toLowerCase()],p.getHeaders=()=>p.headers,a.body&&a.body.data&&p.push(a.body.data,a.body.encoding?"base64":void 0),p.push(null);const m=new n.default;m.finished=!1,Object.defineProperty(m,"statusCode",{get:()=>d.status,set(e){d.status=e,d.statusDescription=c[e]}}),m.headers={};const y={};m.writeHead=(e,t)=>(d.status=e,t&&(m.headers=Object.assign(m.headers,t)),m),m.write=e=>{d.body||(d.body=Buffer.from("")),d.body=Buffer.concat([d.body,Buffer.isBuffer(e)?e:Buffer.from(e)])};let g=t&&(e=>{let t=!1;const r=e["accept-encoding"];if(r)for(let e=0;e<r.length;e++){const{value:a}=r[e];-1!==a.split(",").map((e=>e.split(";")[0].trim())).indexOf("gzip")&&(t=!0)}return t})(f);const b=new Promise((e=>{m.end=t=>{!0!==m.finished&&(m.finished=!0,t&&m.write(t),m.statusCode||(m.statusCode=200),d.body&&(d.bodyEncoding="base64",d.body=g?i.default.gzipSync(d.body).toString("base64"):Buffer.from(d.body).toString("base64")),d.headers=((e,t,r)=>{const a={},o={};return Object.entries(r).forEach((([e,t])=>{o[e.toLowerCase()]=t})),Object.entries(e).forEach((([e,r])=>{const n=e.toLowerCase();e=t[n]||e,u[n]?o[n]&&(a[n]=o[n]):(a[n]=[],r instanceof Array?r.forEach((t=>{a[n].push({key:e,value:t.toString()})})):a[n].push({key:e,value:r.toString()}))})),a})(m.headers,y,o.headers),g&&(d.headers["content-encoding"]=[{key:"Content-Encoding",value:"gzip"}]),e(d))}}));return m.setHeader=(e,t)=>{m.headers[e.toLowerCase()]=t,y[e.toLowerCase()]=e},m.removeHeader=e=>{delete m.headers[e.toLowerCase()]},m.getHeader=e=>m.headers[e.toLowerCase()],m.getHeaders=()=>m.headers,m.hasHeader=e=>!!m.getHeader(e),{req:p,res:m,responsePromise:b}};h.SPECIAL_NODE_HEADERS=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];var p=h;const f=async()=>{const{defaultRetryDecider:e,StandardRetryStrategy:t}=await Promise.resolve().then((function(){return require("./index-9215a09b.js")}));return new t((async()=>3),{retryDecider:t=>"code"in t&&("ECONNRESET"===t.code||"EPIPE"===t.code||"ETIMEDOUT"===t.code)||e(t)})};exports.handler=async e=>{await Promise.all(e.Records.map((async e=>{const t=JSON.parse(e.body),r=d.default,{req:a,res:o}=p({request:t.cloudFrontEventRequest},{enableHTTPCompression:r.enableHTTPCompression}),n=require(`./${t.pagePath}`),{renderOpts:i,html:s}=await n.renderReqToHTML(a,o,"passthrough");await(async e=>{const{S3Client:t}=await Promise.resolve().then((function(){return require("./S3Client-42463716.js")})),r=new t({region:e.region,maxAttempts:3,retryStrategy:await f()}),a=e.basePath?`${e.basePath.replace(/^\//,"")}/`:"",o=e.uri.replace(/^\//,"").replace(/\.(json|html)$/,"").replace(/^_next\/data\/[^\/]*\//,""),n=`_next/data/${e.buildId}/${o}.json`,i=`static-pages/${e.buildId}/${o}.html`,s=e.revalidate?void 0:"public, max-age=0, s-maxage=2678400, must-revalidate",d=e.revalidate?new Date((new Date).getTime()+1e3*e.revalidate):void 0,u={Bucket:e.bucketName,Key:`${a}${n}`,Body:JSON.stringify(e.pageData),ContentType:"application/json",CacheControl:s,Expires:d},c={Bucket:e.bucketName,Key:`${a}${i}`,Body:e.html,ContentType:"text/html",CacheControl:s,Expires:d},{PutObjectCommand:l}=await Promise.resolve().then((function(){return require("./PutObjectCommand-564a65ed.js")}));return await Promise.all([r.send(new l(u)),r.send(new l(c))]),{cacheControl:s,expires:d}})({html:s,uri:t.cloudFrontEventRequest.uri,basePath:t.basePath,bucketName:t.bucketName,buildId:r.buildId,pageData:i.pageData,region:t.region,revalidate:i.revalidate})})))};
